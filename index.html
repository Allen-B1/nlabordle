<style> 
    main { 
        width: 512px;
        margin: auto;
        display: none;
    }
    #guesses { 
        margin-top: 8px;
    }
    .guess {
        display: flex;
        flex-direction: row;
        padding: 0 8px;
        padding-right: 0;
        margin: 8px 0;
        align-items: center;
    }
    .guess :first-child {
        flex-grow: 1;
    }
    .guess :not(:first-child) {
        width: 32px;
        height: 32px;
        line-height: 32px;
        text-align: center;
        margin: 0 4px;
    }

    .blue {
        background: hsl(200, 90%, 60%); }
    .green {
        background: hsl(130, 90%, 60%); }
    .lime {
        background: hsl(80, 90%, 60%); }
    .yellow {
        background: hsl(60, 90%, 60%); }
    .amber {
        background: hsl(45, 90%, 55%); }
    .orange {
        background: hsl(25, 90%, 50%);
        color: white; }
    .red {
        background: hsl(0, 90%, 50%);
        color: white; }

    #form { 
        display: flex;
        flex-direction: row;
    }
    #form input { flex-grow: 1; padding: 4px 8px; border: 2px solid black; }
    #form button { width: 72px; padding: 4px 8px; margin-left: 8px; }
    h1, #tagline {
        text-align: center;
        margin: 0;
    }
    h1 {
        margin-top: 64px;
    }
    #tagline { margin-bottom: 16px; }

    .invalid {
        border-color: red  !important;
    }

    .tag {
        font-size: 12px;
        padding: 4px 8px;
        display: inline-block;
        background: hsl(0, 75%, 50%);
        color: white;
        
        position: relative;
        top: -4px;
    }
</style>

<meta charset="utf8">

<h1>
    nlabordle <span class="tag">alpha</span>
</h1>
<div id="tagline">
    <span id="today"></span> | <span id="difficulty">loading...</span>
</div>

<main id="main">
    <div id="form">
        <input list="articles" placeholder="Guess" id="input" onkeydown="if (event.keyCode == 13) guess()">
        <button onclick="guess()">Guess</button>    
    </div>
    <div id="guesses">

    </div>
</main>

<datalist id="articles">

</datalist>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js" integrity="sha512-g2TeAWw5GPnX7z0Kn8nFbYfeHcvAu/tx6d6mrLe/90mkCxO+RcptyYpksUz35EO337F83bZwcmUyHiHamspkfg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    let data;

    function resolveLink(link) {
        if (data[link] == undefined) {
//            console.warn("unknown article when resolving: " + link);
            return link;
        }
        if (data[link].redirect &&data[link].redirect != link) {
            return resolveLink(data[link].redirect);
        }
        return link;
    }

    function computeCommonLinks(a, b) {
        a = resolveLink(a); b = resolveLink(b);
        let aLinks = new Set(data[a].links.map(resolveLink));
        let bLinks = new Set(data[b].links.map(resolveLink));
        for (let article in data) {
            if (data[article].links && data[article].links.map(resolveLink).includes(a)) {
                aLinks.add(article);
            }
            if (data[article].links && data[article].links.map(resolveLink).includes(b)) {
                bLinks.add(article);
            }
        }
//        console.info(aLinks.intersection(bLinks));
        return aLinks.intersection(bLinks).size;
    }

    function computeDistance(from, target) {
        from = resolveLink(from);
        target = resolveLink(target);

        if (from == target) { return 0; }

        let distances = {};
        distances[from] = 0;

        let queue = [from];
        for (;;) {
            let article = queue.shift();
            if (!article) {
                break;
            }

            if (!(data[article] && data[article].links)) {
//                console.warn("unknown article when computing: " + article);
                continue;
            }

            let links = data[article].links.map(link => resolveLink(link));
            for (let link of links) {
                if (link in distances) {
                    continue;
                }

                distances[link] = distances[article] + 1;
                if (link == target) {
                    break;
                }
                queue.push(link);
            }
        }

        return distances[target];
    }

    let filteredArticles;
    let artMap = {};
    async function main() {
        data = JSON.parse(new TextDecoder().decode(pako.inflate(await (await fetch("data.bin")).arrayBuffer())));

        // load article pool
        for (let article in data) {
            if (!data[article].links) continue;
            for (let link of data[article].links) {
                link = resolveLink(link);
                artMap[link] = (artMap[link] | 0) + 1;
            }
        }

        filteredArticles = Object.keys(data).filter(art => data[art].links).filter(art => artMap[art] >= 64);
        filteredArticles.sort();

        const links = artMap[filteredArticles[random(today, filteredArticles.length)]];
        let difficulty = links >= 512 ? "easy" :
            links >= 256 ? "medium" : 
            links >= 128 ? "hard" : "impossible"; 
        document.getElementById("difficulty").innerText = difficulty + " [" + links + "]";

        // load datalist
        const datalist = document.getElementById("articles");
        for (let article of filteredArticles) {
            let option = document.createElement("option");
            option.textContent = article;
            datalist.appendChild(option);
        }

        // start game
        document.getElementById("main").style.display = "block";
    }
    main();

    // GUI
    const date = new Date();
    const today = date.getFullYear() +  "-" + (date.getMonth() + 1) + "-" + date.getDate();
    document.getElementById("today").textContent = today;

    const inputElem  = document.getElementById("input");
    inputElem.oninput = function() { 
        inputElem.className = "";
    };
    const guessesElem = document.getElementById("guesses");

    const targets = {
        "2024-10-24": "set",
        "2024-10-25": "object",
        "2024-10-26": "ring",
        "2024-10-27": "differential form",
        "2024-10-28": "manifold",
        "2024-10-29": "rational number",
        "2024-10-30": "circle",
//        "2024-10-27": "The Rising Sea",
//        "2024-10-28": "decategorification"
    };

    function random(date, n) {
        let year = date.split("-")[0] | 0,
            month = date.split("-")[1] | 0,
            day = date.split("-")[2] | 0;
        let hash = day + month * 31 + year * 31 * 12;
        hash ^= hash << 13;
        hash ^= hash >> 7;
        hash ^= hash << 17;
        return ((hash % n) + n) % n;
    }
    
    let previousGuesses = new Set();
    function guess() {
        let guessLink = resolveLink(inputElem.value);
        if (!(guessLink in data) || previousGuesses.has(guessLink)) {
            inputElem.classList.add("invalid");
            return;
        }
        inputElem.className = "";
        previousGuesses.add(guessLink);

        let guess = document.createElement("div");
        guess.className = "guess";

        let article = document.createElement("div");
        article.innerText = guessLink;

        let distanceElem = document.createElement("div");
        let occursElem = document.createElement("div");
        let commonLinksElem = document.createElement("div");

        guess.appendChild(article);
        guess.appendChild(distanceElem);
        guess.appendChild(commonLinksElem);
        guess.appendChild(occursElem);

        guessesElem.prepend(guess);

        setTimeout(() => {
            const target = filteredArticles[random(today, filteredArticles.length)];
//            console.info(target);

            let dists = [];
            let dist = computeDistance(guessLink, target);
            if (dist !== undefined) dists.push(dist);
            let revDist = computeDistance(target, guessLink);
            if (revDist !== undefined) dists.push(revDist);
            let avgDist = dists.length == 0 ? "âˆž" : dists.reduce((a, b) => a + b, 0) / dists.length;

            distanceElem.innerText = avgDist;
            distanceElem.classList.add(numberToColor(avgDist));
            function numberToColor(num) {
                return num == 0 ? "blue" : 
                    num <= 1 ? "green" : 
                    num <= 1.5 ? "lime" :
                    num <= 2 ? "yellow" : 
                    num <= 2.5 ? "amber" : 
                    num <= 3 ? "orange" : "red";
            }

            let commonLinks = computeCommonLinks(target, guessLink);
            commonLinksElem.innerText = commonLinks;
            commonLinksElem.classList.add(
                resolveLink(target) == guessLink ? "blue" : 
                commonLinks >= 64 ? "green" : 
                commonLinks >= 32 ? "lime" :
                commonLinks >= 16 ? "yellow" : 
                commonLinks >= 6 ? "amber" :
                commonLinks >= 1 ? "orange" : "red");

            let occurences = data[target].content.split(guessLink).length - 1;
            occursElem.innerText = occurences;
            occursElem.classList.add(
                resolveLink(target) == guessLink ? "blue" : 
                occurences >= 10 ? "green" : 
                occurences >= 7 ? "lime" :
                occurences >= 4 ? "yellow" : 
                occurences >= 2 ? "amber" :
                occurences >= 1 ? "orange" : "red");
            if (resolveLink(target) == guessLink) {
                guess.classList.add("blue");
            }
        }, 50);
    }
</script>